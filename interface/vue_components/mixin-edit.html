<script>

var editMixin = {
    data : function () { return { tool_hashtag:'mix-n-match' } } ,
	created : function () {
	} ,
	methods : {
		onCreateMatch : function ( q , wdq , callback ) {
			let me = this ;

			Promise.all ( [
				new Promise(function(resolve, reject) { // Edit in Mix'n'match
					let now = new Date(Date.now()) ;
					let data = { claims:[ widar.newClaimString(_props.manual,wdq) ] } ;
					data.claims[0].qualifiers = {} ;
					data.claims[0].qualifiers[_props.matched_by] = [ widar.newClaimString(_props.matched_by,widar.getUserName()).mainsnak ] ;
					data.claims[0].qualifiers[_props.matched_on] = [ widar.newClaimDate(_props.matched_on,now.toISOString().substr(0,10)).mainsnak ] ;
					me.editEntity ( q , data , resolve ) ;
				} ) ,
				new Promise(function(resolve, reject) { // Edit in Wikidata
					wd.getItemBatch ( [q] , function () {
						let i = wd.getItem ( q ) ;
						if ( typeof i == 'undefined' || !i.hasClaims(_props.catalog) || !i.hasClaims(_props.ext_id) ) return resolve() ; // No catalog, no WD edit
						let catalog_q = i.getClaimItemsForProperty(_props.catalog,true)[0] ;
						let ext_id = i.getFirstStringForProperty(_props.ext_id) ;
						wd.getItemBatch ( [catalog_q] , function () {
							let ci = wd.getItem ( catalog_q ) ;
							if ( typeof ci == 'undefined' || !ci.hasClaims(_props.wd_prop) ) return resolve() ; // No info in catalog, no WD edit
							let wd_prop = ci.getFirstStringForProperty(_props.wd_prop) ;
							let summary = '' ; // TODO
							let claim = widar.newClaimString ( wd_prop , ext_id ) ;
							widar.addClaimToItem ( wdq , claim , summary , me.tool_hashtag , resolve ) ;
						} ) ;
					} ) ;
				} )
		    ] ) .then ( () => {
				me.reloadItem ( q , callback ) ;
		    } ) ;

		} ,
		onRemoveMatch : function ( q , wdq , callback ) {
			let me = this ;
			let user = widar.getUserName() ;
			console.log ( 'REMOVE' , q , wdq ) ;
			me.reloadItem ( q , callback ) ;
		} ,
		editEntity : function ( q , data , callback ) {
			let me = this ;
			me.getEditToken ( function ( token ) {
				$.post ( '/w/api.php' , {
					action:'wbeditentity',
					id:q,
					summary:'Edit on behalf of Wikidata:User:'+widar.getUserName(),
					token:token,
					data:JSON.stringify(data),
					format:'json'
				} , function ( d ) {
					if ( typeof callback != 'undefined' ) callback() ;
				} , 'json' ) ;
			} ) ;
		} ,
		getEditToken : function ( callback ) {
			$.get ( '/w/api.php' , {
				action:'query',
				meta:'tokens',
				format:'json'
			} , function ( d ) {
				callback ( d.query.tokens.csrftoken ) ;
			} , 'json' ) ;
		} ,
		getWikiUserName : function () { // NOT USED
			if ( global_configuration.loading_userdata ) return ;
			if ( global_configuration.is_logged_in ) return ;
			global_configuration.loading_userdata = true ;
			global_configuration.is_logged_in = false ;
			global_configuration.username = '' ;
			let url = global_configuration.mwapi+'?action=query&meta=userinfo&format=json' ;
			$.get ( url , function (d) {
				if ( d.query.userinfo.id == 0 ) return ;
				global_configuration.is_logged_in = true ;
				global_configuration.username = d.query.userinfo.name ;
			} , 'json' ) ;
		} ,
		getMatchedByUserNameFromClaim : function ( c ) {
			if ( typeof c == 'undefined' ) return '' ;
			if ( typeof c.qualifiers == 'undefined' ) return '' ;
			return (typeof c.qualifiers[_props['matched_by']]=='undefined') ? '' : c.qualifiers[_props['matched_by']][0].datavalue.value ;
		} ,
		reloadItem : function ( q , callback ) {
			let api_params = {
				action : 'wbgetentities' ,
				ids : q ,
				props : wd.default_props ,
				format : 'json'
			} ;
			$.getJSON ( wd.api , api_params , function ( data ) {
				$.each ( (data.entities||[]) , function ( k , v ) {
					let i = new WikiDataItem ( wd , data.entities[q] ) ;
					Vue.set ( wd.items , q , i ) ;
				} ) ;
				if ( typeof callback != 'undefined' ) callback() ;
			} ) ;
		} ,
		getUserLink : function ( user ) {
			if ( user == '' ) return '' ;
            if ( /^Mix'n'match /.test(user) ) {
                return '<i>' + user + '</i>' ;
            } else {
                return "<a href='https://www.wikidata.org/wiki/User:"+encodeURIComponent(user).replace(/'/g,'&apos;')+"' target='_blank' class='wikidata'>" + user + "</a>" ;
            }
		} ,
	}
} ;

</script>